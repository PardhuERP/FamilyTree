<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Add Member | MyFamilyTree</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" href="css/style.css">
</head>

<body>

<div class="toolbar addBar">
  <button class="backBtn" onclick="history.back()">‚Üê</button>
  <span class="appTitle">Add Person</span>
</div>

<div class="addPage">

<h2>Add New Family Member</h2>

<label class="fieldLabel">Full Name</label>
<input id="pname" placeholder="Enter name">

<label class="fieldLabel">Gender</label>
<select id="pgender">
  <option>Male</option>
  <option>Female</option>
</select>

<label class="fieldLabel">Date of Birth</label>
<input type="date" id="pdob">

<label class="fieldLabel">Blood Group</label>
<select id="pblood">
  <option value="">Select Blood Group</option>
  <option>O+</option>
  <option>O-</option>
  <option>A+</option>
  <option>A-</option>
  <option>B+</option>
  <option>B-</option>
  <option>AB+</option>
  <option>AB-</option>
</select>

<label class="fieldLabel">Qualification</label>
<input id="pedu" placeholder="B.Tech, MBA etc">

<label class="fieldLabel">Photo</label>
<input type="file" id="pphoto" accept="image/*">

<img id="previewPhoto"
     style="width:80px;height:80px;
            border-radius:10px;
            margin-top:8px;
            display:none;">

<label class="fieldLabel">Place</label>
<input id="pplace" placeholder="Village / City">


<!-- INFO TEXT -->
<small id="parentInfo"
       style="color:#2563eb; display:block; margin-bottom:6px;">
</small>

<label class="fieldLabel">üëÜ Select below opposite relationshipüëá </label>
<select id="relationType">
  <option value="Select next relation"</option>
  <option value="father">Father</option>
  <option value="spouse">Spouse</option>
  <option value="mother">Mother</option>
</select>

<!-- hidden values (system use only) -->
<input id="pfather" type="hidden">
<input id="pmother" type="hidden">
<input id="pspouse" type="hidden">

<button id="addBtn">Save Person üòä</button>

</div>

<script>
window.API_URL =
"https://script.google.com/macros/s/AKfycbytM7snXYUkPLqdkIb9z-CQkUyDVRoUx1ef7-r02duWq139BWq1xWgg8m11BMgEOgVB/exec";
</script>

<script src="js/tree.js"></script>

  <script>
document.addEventListener("DOMContentLoaded", function () {

  const relation = document.getElementById("relationType");

  const pfather = document.getElementById("pfather");
  const pmother = document.getElementById("pmother");
  const pspouse = document.getElementById("pspouse");

  const pid = localStorage.getItem("selectedParent");
  const gender = localStorage.getItem("selectedParentGender");
  const spouseId = localStorage.getItem("selectedParentSpouse");

  relation.addEventListener("change", function(){

    // reset all
    pfather.value = "";
    pmother.value = "";
    pspouse.value = "";

    if(!pid) return;

    // =====================
    // CHILD
    // =====================
    if(this.value === "child"){

      if(gender === "Male"){
        pfather.value = pid;
        pmother.value = spouseId || "";
      }
      else{
        pmother.value = pid;
        pfather.value = spouseId || "";
      }
    }

    // =====================
    // SPOUSE
    // =====================
    else if(this.value === "spouse"){
      pspouse.value = pid;
    }

    // =====================
    // FATHER
    // =====================
    else if(this.value === "father"){

      // new person becomes father
      pmother.value = pid;

      // auto fill other parent if exists
      if(spouseId){
        pfather.value = spouseId;
      }
    }

    // =====================
    // MOTHER
    // =====================
    else if(this.value === "mother"){

      pfather.value = pid;

      if(spouseId){
        pmother.value = spouseId;
      }
    }

  });

});
</script>

<!-- ===============================
     PARENT AUTO SET LOGIC
================================ -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const pid = localStorage.getItem("selectedParent");
  const pname = localStorage.getItem("selectedParentName");
  const gender = localStorage.getItem("selectedParentGender");

  const pfather = document.getElementById("pfather");
  const pmother = document.getElementById("pmother");
  const info = document.getElementById("parentInfo");

  if(!pid){
    info.innerText =
      "No parent selected. Go back and tap a person.";
    return;
  }

  // =========================
  // MALE CLICKED
  // =========================
  if(gender === "Male"){

    pfather.value = pid;

    info.innerText =
      "Child of Father: " + pname + " (" + pid + ")";
  }

  // =========================
  // FEMALE CLICKED
  // =========================
  else if(gender === "Female"){

    pmother.value = pid;

    info.innerText =
      "Child of Mother: " + pname + " (" + pid + ")";

    // find husband automatically
    fetch(API_URL +
      "?action=getTree" +
      "&familyId=" + localStorage.getItem("familyId") +
      "&userId=" + localStorage.getItem("userId"))
    .then(r=>r.json())
    .then(res=>{

      if(res.status !== "OK") return;

      const persons = res.data;

      const mother =
        persons.find(p => p.personId === pid);

      let fatherId = "";

      // CASE 1 ‚Äî spouseId exists
      if(mother && mother.spouseId){
        fatherId = mother.spouseId.split(",")[0];
      }

      // CASE 2 ‚Äî reverse spouse search
      else{
        const husband = persons.find(p =>
          String(p.spouseId || "")
            .split(",")
            .includes(pid)
        );

        if(husband){
          fatherId = husband.personId;
        }
      }

      if(fatherId){
        pfather.value = fatherId;
      }

    });
  }

});
</script>

<!-- ===============================
     PHOTO COMPRESS (OLD LOGIC)
================================ -->
<script>
document.getElementById("pphoto")
.addEventListener("change", function(e){

  const file = e.target.files[0];
  if(!file) return;

  const img = new Image();
  const reader = new FileReader();

  reader.onload = ev => img.src = ev.target.result;

  img.onload = function(){

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const MAX = 200;
    let w = img.width;
    let h = img.height;

    if(w > h){
      if(w > MAX){
        h *= MAX / w;
        w = MAX;
      }
    }else{
      if(h > MAX){
        w *= MAX / h;
        h = MAX;
      }
    }

    canvas.width = w;
    canvas.height = h;
    ctx.drawImage(img,0,0,w,h);

    const compressed =
      canvas.toDataURL("image/jpeg",0.7);

    document.getElementById("previewPhoto").src = compressed;
    document.getElementById("previewPhoto").style.display="block";

    window.photoBase64 = compressed;
  };

  reader.readAsDataURL(file);
});
</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HD Photo Update | MyFamilyTree</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" href="css/style.css">
</head>

<body>

<!-- TOOLBAR -->
<div class="toolbar addBar">
  <button class="backBtn" onclick="history.back()">←</button>
  <span class="appTitle">HD Photo</span>
</div>

<div class="addPage">

  <h2>Update HD Photo</h2>

  <label class="fieldLabel">Select Photo</label>
  <input type="file"
         id="pphoto"
         accept="image/*">

  <img id="previewPhoto"
       style="width:120px;
              height:120px;
              border-radius:10px;
              margin-top:10px;
              display:none;">

  <br><br>

  <button onclick="uploadHDPhoto()">
    Upload HD Photo
  </button>

</div>

<script>
window.API_URL =
"https://script.google.com/macros/s/AKfycbytM7snXYUkPLqdkIb9z-CQkUyDVRoUx1ef7-r02duWq139BWq1xWgg8m11BMgEOgVB/exec";
</script>

<script>

/* ---------- PHOTO COMPRESS (HD) ---------- */

document.getElementById("pphoto")
.addEventListener("change", function(e){

  const file = e.target.files[0];
  if(!file) return;

  const img = new Image();
  const reader = new FileReader();

  reader.onload = ev => img.src = ev.target.result;

  img.onload = function(){

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const MAX = 1920;   // TRUE HD LIMIT

    let w = img.width;
    let h = img.height;

    if(w > h && w > MAX){
      h *= MAX / w;
      w = MAX;
    }
    else if(h > MAX){
      w *= MAX / h;
      h = MAX;
    }

    canvas.width = w;
    canvas.height = h;

    ctx.drawImage(img,0,0,w,h);

    const compressed =
      canvas.toDataURL("image/jpeg",0.95);

    previewPhoto.src = compressed;
    previewPhoto.style.display = "block";

    window.photoBase64 = compressed;
  };

  reader.readAsDataURL(file);
});


/* ---------- UPLOAD HD PHOTO ---------- */

function uploadHDPhoto(){

  if(!window.photoBase64){
    alert("Select photo first");
    return;
  }

  const personId =
    localStorage.getItem("editPersonId");

  if(!personId){
    alert("Person not selected");
    return;
  }

  fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      action:"uploadPhotoHD",
      personId: personId,
      photoBase64: window.photoBase64
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status === "OK"){
      alert("HD Photo Updated ✅");
      history.back();
    }else{
      alert("Upload failed");
    }
  })
  .catch(()=>{
    alert("Network error");
  });
}

</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Edit Member | MyFamilyTree</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" href="css/style.css">
</head>

<body>

<!-- TOOLBAR -->
<div class="toolbar addBar">
  <button class="backBtn" onclick="history.back()">‚Üê</button>
  <span class="appTitle">Edit Person</span>
</div>

<div class="addPage">

  <h2>Edit Family Member</h2>

  <label class="fieldLabel">Full Name</label>
  <input id="pname" placeholder="Enter name">

  <label class="fieldLabel">Gender</label>
  <select id="pgender">
    <option>Male</option>
    <option>Female</option>
  </select>

  <label class="fieldLabel">Date of Birth</label>
  <input type="date" id="pdob">

  <label class="fieldLabel">Blood Group</label>
<select id="pblood">
  <option value="">Select Blood Group</option>
  <option>O+</option>
  <option>O-</option>
  <option>A+</option>
  <option>A-</option>
  <option>B+</option>
  <option>B-</option>
  <option>AB+</option>
  <option>AB-</option>
</select>
  
<label class="fieldLabel">Qualification</label>
<input id="pedu" placeholder="B.Tech, MBA etc">

<label class="fieldLabel">Photo</label> 
<input type="file" id="pphoto" accept="image/*">

<img id="previewPhoto"
     style="width:80px;height:80px;
            border-radius:10px;
            margin-top:8px;
            display:none;">

  <label class="fieldLabel">Place</label>
  <input id="pplace" placeholder="Village / City">

  <label class="fieldLabel">Father ID</label>
  <small id="parentInfo" style="color:#2563eb; display:block; margin-bottom:6px;"></small>
  <input id="pfather">

  <label class="fieldLabel">Mother</label>
<select id="pmother">
  <option value="">Select Mother</option>
</select>
  

  <label class="fieldLabel">Spouse ID (optional)</label>
  <input id="pspouse" placeholder="Cut aboveüëÜ Father ID & paste here">

  <button id="updateBtn">Update Personüòä</button>
</div>

<script>
window.API_URL =
"https://script.google.com/macros/s/AKfycbytM7snXYUkPLqdkIb9z-CQkUyDVRoUx1ef7-r02duWq139BWq1xWgg8m11BMgEOgVB/exec";
</script>

<script>
document.addEventListener("DOMContentLoaded", function(){

  const personId = localStorage.getItem("editPersonId");
  const familyId = localStorage.getItem("familyId");

  const pfather = document.getElementById("pfather");

  // ‚úÖ attach listener here (ONLY ONCE)
  if(pfather){
    pfather.addEventListener("change", loadMothers);
  }

  if(!personId) return;

  fetch(API_URL +
    "?action=getTree" +
    "&familyId=" + familyId +
    "&userId=" + localStorage.getItem("userId"))
  .then(r=>r.json())
  .then(res=>{

    if(res.status !== "OK") return;

    const p = res.data.find(x => x.personId === personId);
    if(!p) return;

    document.getElementById("pname").value = p.name || "";
    document.getElementById("pgender").value = p.gender || "";
    document.getElementById("pdob").value =
      (p.dob || "").split("T")[0];

    document.getElementById("pblood").value =
      p.bloodGroup || "";

    document.getElementById("pedu").value =
      p.qualification || "";

    document.getElementById("pplace").value =
      p.place || "";

    document.getElementById("pfather").value =
      p.fatherId || "";

    document.getElementById("pspouse").value =
      p.spouseId || "";

    // photo preview
    if(p.photoUrl){
      document.getElementById("previewPhoto").src = p.photoUrl;
      document.getElementById("previewPhoto").style.display = "block";
    }

    // ‚úÖ load mothers after father filled
    loadMothers();

    // ‚úÖ select existing mother
    setTimeout(()=>{
      document.getElementById("pmother").value =
        p.motherId || "";
    },300);

  });

});
</script>
  
  <script>
document.getElementById("pphoto")
.addEventListener("change", function(e){

  const file = e.target.files[0];
  if(!file) return;

  const img = new Image();
  const reader = new FileReader();

  reader.onload = function(ev){
    img.src = ev.target.result;
  };

  img.onload = function(){

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const MAX = 200; // thumbnail size
    let w = img.width;
    let h = img.height;

    if(w > h){
      if(w > MAX){
        h *= MAX / w;
        w = MAX;
      }
    }else{
      if(h > MAX){
        w *= MAX / h;
        h = MAX;
      }
    }

    canvas.width = w;
    canvas.height = h;
    ctx.drawImage(img,0,0,w,h);

    const compressed =
      canvas.toDataURL("image/jpeg",0.7);

    document.getElementById("previewPhoto").src = compressed;
    document.getElementById("previewPhoto").style.display="block";

    window.photoBase64 = compressed; // üî• store for upload
  };

  reader.readAsDataURL(file);
});
  </script>

  <script>

   function loadMothers(){

  const fatherId =
    document.getElementById("pfather").value;

  if(!fatherId) return;

 fetch(API_URL,{
  method:"POST",
  body: JSON.stringify({
    action:"updatePerson",
    personId:id,
    name:name,
    gender:gender,
    dob:dob,
    bloodGroup:blood,
    qualification:edu,
    place:place,
    fatherId:fatherId,
    motherId:motherId,
    spouseId:spouseId,
    photoUrl: window.photoBase64 || ""
  })
})
.then(r=>r.json())
.then(res=>{
  alert("Updated successfully");
  window.location.href="index.html";
})
.catch(()=>{
  alert("Network error");
}); 
} 
  </script>
<script>

  document.getElementById("updateBtn").onclick = function(){

  const id = localStorage.getItem("editPersonId");

  const name = document.getElementById("pname").value;
  const gender = document.getElementById("pgender").value;
  const dob = document.getElementById("pdob").value;
  const blood = document.getElementById("pblood").value;
  const edu = document.getElementById("pedu").value;
  const place = document.getElementById("pplace").value;
  const fatherId = document.getElementById("pfather").value;
  const motherId = document.getElementById("pmother").value;
  const spouseId = document.getElementById("pspouse").value;

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "updatePerson",
      personId: id,
      name: name,
      gender: gender,
      dob: dob,
      bloodGroup: blood,
      qualification: edu,
      place: place,
      fatherId: fatherId,
      motherId: motherId,
      spouseId: spouseId,
      photoUrl: window.photoBase64 || ""
    })
  })
  .then(r=>r.json())
  .then(res=>{
    alert("Updated successfully");
    window.location.href = "index.html";
  })
  .catch(()=>{
    alert("Network error");
  });

};
</script>
</body>
</html>  

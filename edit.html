<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Edit Member | MyFamilyTree</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" href="css/style.css">
</head>

<body>

<!-- TOOLBAR -->
<div class="toolbar addBar">
  <button class="backBtn" onclick="history.back()">‚Üê</button>
  <span class="appTitle">Edit Person</span>
</div>

<div class="addPage">

  <h2>Edit Family Member</h2>

  <label class="fieldLabel">Full Name</label>
  <input id="pname" placeholder="Enter name">

  <label class="fieldLabel">Gender</label>
  <select id="pgender">
    <option>Male</option>
    <option>Female</option>
  </select>

  <label class="fieldLabel">Date of Birth</label>
  <input type="date" id="pdob">

  <label class="fieldLabel">Blood Group</label>
  <select id="pblood">
  <option value="">Select Blood Group</option>
  <option>O+</option>
  <option>O-</option>
  <option>A+</option>
  <option>A-</option>
  <option>B+</option>
  <option>B-</option>
  <option>AB+</option>
  <option>AB-</option>
</select>

  <label class="fieldLabel">Qualification</label>
  <input id="pedu" placeholder="B.Tech, B.com">

  <label class="fieldLabel">Place</label>
  <input id="pplace" placeholder="Village name">

  <label class="fieldLabel">Father ID</label>
  <small id="parentInfo"
         style="color:#2563eb; display:block; margin-bottom:6px;"></small>
  <input id="pfather">

  <label class="fieldLabel">Mother</label>
  <select id="pmother">
    <option value="">Select Mother</option>
  </select>

  <label class="fieldLabel">Spouse ID</label>
  <input id="pspouse" placeholder="Cut above üëÜ Father ID & Paste here">

  <button id="updateBtn">Update Personüòä</button>
  <button id="uploadPhotoBtn">Upload Photo üì∑</button>

</div>

<script>
window.API_URL =
"https://script.google.com/macros/s/AKfycbytM7snXYUkPLqdkIb9z-CQkUyDVRoUx1ef7-r02duWq139BWq1xWgg8m11BMgEOgVB/exec";
</script>

<script>

/* ---------- LOAD PERSON DATA ---------- */
document.addEventListener("DOMContentLoaded", function(){

  const personId = localStorage.getItem("editPersonId");
  const familyId = localStorage.getItem("familyId");
  const userId = localStorage.getItem("userId");

  fetch(API_URL +
    "?action=getTree" +
    "&familyId=" + familyId +
    "&userId=" + userId)
  .then(r=>r.json())
  .then(res=>{

    const p = res.data.find(x=>x.personId === personId);
    if(!p) return;

    pname.value = p.name || "";
    pgender.value = p.gender || "";
    pdob.value = (p.dob || "").split("T")[0];
    pplace.value = p.place || "";
    pfather.value = p.fatherId || "";
    pspouse.value = p.spouseId || "";
    pblood.value = p.bloodGroup || "";
    pedu.value = p.qualification || "";

    // load mothers AFTER father set
    loadMothers();

  });

});


/* ---------- LOAD MOTHERS ---------- */
function loadMothers(){

  const fatherId = pfather.value;
  if(!fatherId) return;

  fetch(API_URL +
    "?action=getTree" +
    "&familyId=" + localStorage.getItem("familyId") +
    "&userId=" + localStorage.getItem("userId"))
  .then(r=>r.json())
  .then(res=>{

    const persons = res.data;

    const wives = persons.filter(p =>
      p.spouseId &&
      String(p.spouseId).split(",").includes(fatherId)
    );

    pmother.innerHTML =
      '<option value="">Select Mother</option>';

    wives.forEach(w=>{
      pmother.innerHTML +=
        `<option value="${w.personId}">
           ${w.name}
         </option>`;
    });

  });
}

pfather.addEventListener("change", loadMothers);


/* ---------- UPDATE PERSON ---------- */
updateBtn.onclick = function(){

  const id = localStorage.getItem("editPersonId");

  fetch(API_URL +
    "?action=updatePerson" +
    "&personId=" + id +
    "&name=" + encodeURIComponent(pname.value) +
    "&gender=" + pgender.value +
    "&dob=" + pdob.value +
    "&place=" + encodeURIComponent(pplace.value) +
    "&bloodGroup=" + pblood.value +
    "&qualification=" + encodeURIComponent(pedu.value) +
    "&fatherId=" + pfather.value +
    "&motherId=" + pmother.value +
    "&spouseId=" + pspouse.value
  )
  .then(r=>r.json())
  .then(res=>{
    alert("Updated");
    localStorage.removeItem("editPersonId");
    window.location.href="index.html";
  });

};

</script> 
  <script>

document.getElementById("uploadPhotoBtn").onclick = function(){

  const id = localStorage.getItem("editPersonId");

  if(!window.photoBase64){
    alert("Select photo first");
    return;
  }

  fetch(API_URL, {
    method:"POST",
    body: JSON.stringify({
      action: "uploadPhoto",
      personId: id,
      photoBase64: window.photoBase64
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="OK"){
      alert("Photo uploaded successfully");
      location.reload();
    }else{
      alert("Upload failed");
    }
  })
  .catch(()=>{
    alert("Network error");
  });

};

  </script>

</body>
</html>

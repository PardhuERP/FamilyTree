<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Select Family | MyFamilyTree</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

<div class="addPage">

  <h2>Your Families</h2>

  <div id="familyList"></div>
  <h3 style="margin-top:25px;">Shared With You</h3>
<div id="sharedFamilyList"></div>

  <div class="createBox">
    <h3>Create New Family</h3>
    <input id="familyName" placeholder="Father Side / Mother Side">
    <button onclick="createFamily()">Create Family</button>
  </div>

  <p id="msg"></p>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbytM7snXYUkPLqdkIb9z-CQkUyDVRoUx1ef7-r02duWq139BWq1xWgg8m11BMgEOgVB/exec";
const userId = localStorage.getItem("userId");

if(!userId){
  location.href = "login.html";
}

// Load families
fetch(API_URL + "?action=getOwnerFamilies&userId=" + userId)
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="OK"){
      showFamilies(res.families);
    }
  });
  // LOAD SHARED FAMILIES
fetch(API_URL + "?action=getSharedFamilies&userId=" + userId)
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="OK"){
      showSharedFamilies(res.families);
    }
  });

function showFamilies(list){
  const box = document.getElementById("familyList");
  box.innerHTML = "";

  if(list.length === 0){
    box.innerHTML = "<p>No families created yet</p>";
    return;
  }

  list.forEach(f=>{
  const div = document.createElement("div");
  div.style.marginBottom = "10px";

 div.className = "familyCard";
div.onclick = function(){
  selectFamily(f.familyId, f.name);
};

div.innerHTML = `
  <div class="familyTitle">ðŸŒ³ ${f.name}</div>
  <div class="familySub">Tap to open family tree</div>
`; 

  box.appendChild(div);
});
}

function selectFamily(fid, fname){
  localStorage.setItem("familyId", fid);
  localStorage.setItem("familyName", fname);
  localStorage.setItem("viewMode", mode);
  location.href = "index.html";
}

function createFamily(){
  const name = document.getElementById("familyName").value;
  if(!name){
    alert("Enter family name");
    return;
  }

  fetch(API_URL + "?action=createFamily&userId=" + userId + "&familyName=" + encodeURIComponent(name))
    .then(r=>r.json())
    .then(res=>{
      if(res.status==="OK"){
        alert("Family created");
        location.reload();
      } else {
        document.getElementById("msg").innerText = res.message;
      }
    });
}

  function showSharedFamilies(list){
  const box = document.getElementById("sharedFamilyList");
  box.innerHTML = "";

  if(!list.length){
    box.innerHTML = "<p>No shared families</p>";
    return;
  }

  list.forEach(f=>{
    const div = document.createElement("div");
    div.style.marginBottom = "10px";

    div.innerHTML = `
      <button style="width:100%;background:#f3f4f6"
        onclick="selectFamily('${f.familyId}', '${f.name}', 'viewer')"
      </button>
    `;

    box.appendChild(div);
  });
      }
</script>

</body>
</html>

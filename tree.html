<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MyFamilyTree Demo</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body { font-family: Arial; margin:0; overflow:hidden; background:#f4f6f8; }
.node rect {
  fill:#fff;
  stroke:#4a90e2;
  stroke-width:2px;
  rx:6; ry:6;
}
.node text { font-size:12px; fill:#333; }
.link {
  fill:none;
  stroke:#999;
  stroke-width:2px;
}
.toolbar{
  position:fixed;
  top:10px; left:10px;
  background:#fff; padding:10px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
}
</style>
</head>

<body>

<div class="toolbar">
  <button onclick="collapseAll()">Collapse All</button>
  <button onclick="expandAll()">Expand All</button>
</div>

<svg width="100%" height="100%"></svg>

<script>
const data = {
  name: "Founder",
  children: [
    { name: "Son 1", children:[
        { name:"Child 1"}, {name:"Child 2"}, {name:"Child 3"}
    ]},
    { name: "Son 2", children:[
        { name:"Child 4"}, {name:"Child 5"}
    ]},
    { name: "Daughter 1", children:[
        { name:"Child 6"}, {name:"Child 7"}, {name:"Child 8"}, {name:"Child 9"}
    ]}
  ]
};

const width = window.innerWidth;
const height = window.innerHeight;
const svg = d3.select("svg")
  .call(d3.zoom().scaleExtent([0.3, 3]).on("zoom", e=>{
    g.attr("transform", e.transform);
  }));

const g = svg.append("g").attr("transform","translate(50,50)");
const treeLayout = d3.tree().nodeSize([80,180]);
let root = d3.hierarchy(data);

root.x0 = height/2;
root.y0 = 0;

function collapse(d){
  if(d.children){
    d._children = d.children;
    d._children.forEach(collapse);
    d.children = null;
  }
}

root.children.forEach(collapse);
update(root);

function update(source){
  const treeData = treeLayout(root);
  const nodes = treeData.descendants();
  const links = treeData.links();

  nodes.forEach(d => d.y = d.depth * 180);

  const node = g.selectAll(".node").data(nodes, d=>d.id || (d.id = ++i));

  const nodeEnter = node.enter().append("g")
    .attr("class","node")
    .attr("transform", d=>`translate(${source.y0},${source.x0})`)
    .on("click", toggle);

  nodeEnter.append("rect")
    .attr("width",100).attr("height",30)
    .attr("x",-50).attr("y",-15);

  nodeEnter.append("text")
    .attr("dy",".35em").attr("text-anchor","middle")
    .text(d=>d.data.name);

  const nodeUpdate = nodeEnter.merge(node);

  nodeUpdate.transition().duration(400)
    .attr("transform", d=>`translate(${d.y},${d.x})`);

  const link = g.selectAll(".link").data(links, d=>d.target.id);

  link.enter().insert("path","g")
    .attr("class","link")
    .attr("d", d=>{
      const o={x:source.x0,y:source.y0};
      return diagonal(o,o);
    })
    .merge(link)
    .transition().duration(400)
    .attr("d", d=>diagonal(d.source,d.target));

  nodes.forEach(d=>{
    d.x0 = d.x;
    d.y0 = d.y;
  });
}

function diagonal(s,d){
  return `M ${s.y} ${s.x}
          C ${(s.y+d.y)/2} ${s.x},
            ${(s.y+d.y)/2} ${d.x},
            ${d.y} ${d.x}`;
}

function toggle(event,d){
  if(d.children){
    d._children = d.children;
    d.children = null;
  } else {
    d.children = d._children;
    d._children = null;
  }
  update(d);
}

function collapseAll(){
  root.children.forEach(collapse);
  update(root);
}
function expandAll(){
  root.each(d=>{
    if(d._children){
      d.children = d._children;
      d._children = null;
    }
  });
  update(root);
}

let i = 0;
</script>
</body>
</html>
